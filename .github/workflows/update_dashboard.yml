name: Update Investment Dashboard (TW Close)

on:
  workflow_dispatch:
  schedule:
    # 台灣時間 18:10 = UTC 10:10
    - cron: "10 10 * * 1-5"

permissions:
  contents: write

concurrency:
  group: investment-dashboard-update
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ✅ 從 GitHub Secrets 還原 Excel
      - name: Restore Excel files from GitHub Secrets
        env:
          TX_XLSX_B64: ${{ secrets.TX_XLSX_B64 }}
          FF_XLSX_B64: ${{ secrets.FF_XLSX_B64 }}
        run: |
          python - <<'PY'
          import os, base64, sys

          def write_b64(env_key, out_path):
              b64 = os.environ.get(env_key, "")
              if not b64.strip():
                  print(f"[ERROR] Missing secret: {env_key}")
                  sys.exit(1)
              data = base64.b64decode(b64)
              with open(out_path, "wb") as f:
                  f.write(data)
              print(f"[OK] Wrote {out_path} ({len(data):,} bytes)")

          write_b64("TX_XLSX_B64", "transactions.xlsx")
          write_b64("FF_XLSX_B64", "Funds Flow.xlsx")
          PY

      - name: Verify restored files
        run: |
          ls -lah
          test -f "transactions.xlsx"
          test -f "Funds Flow.xlsx"

      # ✅ 更新價格（FinMind token 可選）
      - name: Update TW Close prices
        env:
          FINMIND_TOKEN: ${{ secrets.FINMIND_TOKEN }}
        run: |
          python update_prices_tw_close.py

      # ✅ 產出兩個圖的 div/json
      - name: Build Portfolio Value chart
        run: |
          python save_portfolio_chart_for_dashboard.py

      - name: Build Dynamic Performance chart
        run: |
          python save_dynamic_performance_chart_for_dashboard.py

      # ✅ 產出 dashboard.html
      - name: Build dashboard HTML
        run: |
          python build_dashboard_v17_sticky_total_modal_label_analysis_updates.py

      # ✅ Commit & push（push 前先 rebase）
      - name: Commit generated files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          git status

          git commit -m "Auto update dashboard" || echo "No changes to commit"

          git pull --rebase
          git push
